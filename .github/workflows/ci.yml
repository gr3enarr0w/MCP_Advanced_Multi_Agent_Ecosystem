name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  PIP_INDEX_URL: 'https://pypi.org/simple'
  PIP_TRUSTED_HOST: 'pypi.org'

jobs:
  # Build and setup job
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      cache-key-node: ${{ steps.cache-key.outputs.key }}
      cache-key-python: ${{ steps.cache-key-python.outputs.key }}
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Generate cache keys
      id: cache-key
      run: |
        echo "key=node-${{ hashFiles('**/package-lock.json', '**/package.json') }}" >> $GITHUB_OUTPUT
        
    - name: Generate Python cache key
      id: cache-key-python
      run: |
        echo "key=python-${{ hashFiles('**/pyproject.toml', '**/requirements.txt') }}" >> $GITHUB_OUTPUT

    - name: Cache Node modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          **/node_modules
        key: ${{ steps.cache-key.outputs.key }}
        restore-keys: |
          node-

    - name: Cache Python packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.local/share/virtualenvs
        key: ${{ steps.cache-key-python.outputs.key }}
        restore-keys: |
          python-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Run setup script
      run: |
        chmod +x scripts/setup.sh
        ./scripts/setup.sh

    - name: Install MCP servers
      run: |
        chmod +x scripts/install-mcp-servers.sh
        ./scripts/install-mcp-servers.sh

    - name: Upload setup artifacts
      uses: actions/upload-artifact@v3
      with:
        name: setup-artifacts
        path: |
          ~/.mcp/
          MCP_structure_design/mcp-servers-go/dist/
          src/mcp-servers/*/dist/
        retention-days: 1

  # Test Go servers
  test-go-servers:
    name: Test Go Servers
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        server: [task-orchestrator, search-aggregator, skills-manager]
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: go-${{ hashFiles('**/go.sum', '**/go.mod') }}
        restore-keys: |
          go-

    - name: Download setup artifacts
      uses: actions/download-artifact@v3
      with:
        name: setup-artifacts

    - name: Build Go servers
      working-directory: MCP_structure_design/mcp-servers-go
      run: |
        make build

    - name: Test Go server binary
      working-directory: MCP_structure_design/mcp-servers-go
      run: |
        if [ -f "dist/${{ matrix.server }}" ]; then
          echo "✓ ${{ matrix.server }} binary exists"
          chmod +x "dist/${{ matrix.server }}"
          
          # Test startup (should start and exit gracefully for MCP servers)
          timeout 10s ./dist/${{ matrix.server }} || true
          
          # Check if binary is executable and has expected size
          if [ -s "dist/${{ matrix.server }}" ]; then
            echo "✓ ${{ matrix.server }} binary is valid"
          else
            echo "✗ ${{ matrix.server }} binary is invalid"
            exit 1
          fi
        else
          echo "✗ ${{ matrix.server }} binary not found"
          exit 1
        fi

    - name: Run Go integration tests
      working-directory: MCP_structure_design/mcp-servers-go
      run: |
        go test -v ./test/integration/... -timeout 30s

    - name: Upload Go test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: go-test-results-${{ matrix.server }}
        path: |
          MCP_structure_design/mcp-servers-go/test-results/
        retention-days: 7

  # Test TypeScript servers
  test-ts-servers:
    name: Test TypeScript Servers
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        server: [chart-generator, code-intelligence, prompt-cache-mcp, vision-adapter]
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Download setup artifacts
      uses: actions/download-artifact@v3
      with:
        name: setup-artifacts

    - name: Test TypeScript server
      working-directory: src/mcp-servers/${{ matrix.server }}
      run: |
        if [ -f "package.json" ]; then
          echo "Testing ${{ matrix.server }}..."
          
          # Check if build script exists
          if npm run test --if-present; then
            echo "✓ Running tests for ${{ matrix.server }}"
            npm test --if-present
          else
            echo "⚠ No test script found for ${{ matrix.server }}"
          fi
          
          # Check if build exists
          if [ -f "dist/index.js" ] || [ -f "dist/main.js" ]; then
            echo "✓ ${{ matrix.server }} is built"
          else
            echo "⚠ ${{ matrix.server }} build not found"
          fi
        else
          echo "⚠ No package.json found for ${{ matrix.server }}"
        fi

    - name: Upload TypeScript test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ts-test-results-${{ matrix.server }}
        path: |
          src/mcp-servers/${{ matrix.server }}/coverage/
          src/mcp-servers/${{ matrix.server }}/test-results/
        retention-days: 7

  # Test Python servers
  test-python-servers:
    name: Test Python Servers
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Download setup artifacts
      uses: actions/download-artifact@v3
      with:
        name: setup-artifacts

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e src/mcp-servers/context-persistence
        pip install pytest pytest-cov pytest-asyncio

    - name: Test context persistence
      run: |
        cd src/mcp-servers/context-persistence
        python -m pytest tests/ -v --cov=src/context_persistence --cov-report=xml --cov-report=html

    - name: Upload Python test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: python-test-results
        path: |
          src/mcp-servers/context-persistence/coverage.xml
          src/mcp-servers/context-persistence/htmlcov/
          src/mcp-servers/context-persistence/test-results/
        retention-days: 7

  # Test GitHub OAuth server
  test-github-oauth:
    name: Test GitHub OAuth Server
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Download setup artifacts
      uses: actions/download-artifact@v3
      with:
        name: setup-artifacts

    - name: Test GitHub OAuth server
      working-directory: MCP_structure_design/mcp-servers/github-oauth
      run: |
        if [ -f "package.json" ]; then
          npm install
          
          # Basic syntax check
          if node -c index.js; then
            echo "✓ GitHub OAuth server syntax is valid"
          else
            echo "✗ GitHub OAuth server syntax is invalid"
            exit 1
          fi
          
          # Check dependencies
          if npm ls --depth=0; then
            echo "✓ Dependencies are properly installed"
          else
            echo "⚠ Some dependencies may be missing"
          fi
        else
          echo "⚠ No package.json found for GitHub OAuth server"
        fi

  # Run E2E tests
  test-e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [test-go-servers, test-ts-servers, test-python-servers, test-github-oauth]
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Download setup artifacts
      uses: actions/download-artifact@v3
      with:
        name: setup-artifacts

    - name: Run comprehensive E2E tests
      working-directory: MCP_structure_design/mcp-servers-go
      run: |
        chmod +x scripts/final-e2e-test.sh
        ./scripts/final-e2e-test.sh

    - name: Upload E2E test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-results
        path: |
          /tmp/mcp-final-test.log
        retention-days: 7

  # Installation verification
  test-installation:
    name: Installation Verification
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Download setup artifacts
      uses: actions/download-artifact@v3
      with:
        name: setup-artifacts

    - name: Run installation test
      run: |
        chmod +x scripts/test-installation.sh
        ./scripts/test-installation.sh

  # Status check
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [setup, test-go-servers, test-ts-servers, test-python-servers, test-github-oauth, test-e2e, test-installation]
    if: always()
    
    steps:
    - name: Check CI Status
      run: |
        if [ "${{ needs.setup.result }}" == "success" ] && \
           [ "${{ needs.test-go-servers.result }}" == "success" ] && \
           [ "${{ needs.test-ts-servers.result }}" == "success" ] && \
           [ "${{ needs.test-python-servers.result }}" == "success" ] && \
           [ "${{ needs.test-github-oauth.result }}" == "success" ] && \
           [ "${{ needs.test-e2e.result }}" == "success" ] && \
           [ "${{ needs.test-installation.result }}" == "success" ]; then
          echo "✅ All CI jobs passed successfully!"
          exit 0
        else
          echo "❌ Some CI jobs failed:"
          echo "Setup: ${{ needs.setup.result }}"
          echo "Go Tests: ${{ needs.test-go-servers.result }}"
          echo "TS Tests: ${{ needs.test-ts-servers.result }}"
          echo "Python Tests: ${{ needs.test-python-servers.result }}"
          echo "GitHub OAuth: ${{ needs.test-github-oauth.result }}"
          echo "E2E Tests: ${{ needs.test-e2e.result }}"
          echo "Installation: ${{ needs.test-installation.result }}"
          exit 1
        fi